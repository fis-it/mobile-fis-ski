<html>
    <head>
        <title>m.fis-ski.com</title>
        <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
        <script src="phonegap.js"></script>
       <link rel="stylesheet" href="css/mobile_new.css" type="text/css"/>
	<link rel="stylesheet" href="css/FIS_jquery_mobile.css" type="text/css"/>
    <link rel="stylesheet" href="css/jquery.mobile.structure_1.2.0.min.css" />
	<!--[if IE]>
	    <style type="text/css">@import url(http://www.fis-ski.com/css/mobile_ie.css);</style>
	<![endif]-->
    <script src="js/jquery_1.8.2.min.js"></script>
    <script src="js/jquery.mobile_1.2.0.min.js"></script>
    <script src="js/jquery.cookie.js"></script>
    <script src="js/mobile_common_fis.js?v=20131124"></script>
        <!--<script src="js/jquery-1.11.1.min.js"></script>-->
        <script src="js/jquery.jsonp.min.js"></script>
        <script>
            /*document.addEventListener("deviceready", onDeviceReady, false);
            var ref;
            var refpdf;*/
            function fct_exitapp()
            {
                if (navigator.app) {
                    alert('Mobile.fis-ski.com need a internet connection, please activate the internet and try again.')
                    //navigator.app.exitApp();
                    $("#loading").show();
                    $("#tryagain").show();
                } else {
                    $("#loading").html('Mobile.fis-ski.com need a internet connection, please activate the internet and try again.');
                    $("#loading").show();
                    $("#tryagain").show();
                }
            }
            function callbackforpdf(event) {
                alert ('loading ref');
                if (event.url.indexOf(".pdf") > 0) { // || event.url.indexOf("data.fis-ski.com") > 0
                    refpdf = window.open(event.url, '_blank', 'location=yes');
                    alert('ok');
                    refpdf.addEventListener('loadstart', function() {
                        alert('OK 2');
                        ref.addEventListener('loadstart', callbackforpdf);
                        //refpdf = window.open(event.url, '_blank', 'location=yes');
                    }
                    );
                }
            }
            function fct_clearcache()
            {
                $("#loading").show();
                /*if (navigator.app) {
                 navigator.app.clearCache();
                 }*/
                window.plugins.powerManagement.acquire();
                window.plugin.backgroundMode.enable();
                /*window.plugins.ChildBrowser.showWebPage('http://m.fisski.com/?inapp=true',
                 { showLocationBar: false,
                 showAddress: false,
                 showNavigationBar:false
                 });
                 window.plugins.ChildBrowser.onLocationChange = function (url) {
                 if (url.indexOf(".pdf") > 0 || url.indexOf("data.fis-ski.com") > 0) {
                 window.plugins.ChildBrowser.openExternal(url);
                 window.plugins.ChildBrowser.showWebPage(v_page_referer);
                 } else {
                 v_page_referer = url;
                 }
                 };*/
                //ref = window.open('http://m.fis-ski.com/?inapp=true', '_blank', 'location=yes,toolbar=no,suppressesIncrementalRendering=yes,disallowoverscroll=yes,presentationstyle=pagesheet');

                //ref.addEventListener('loadstart', callbackforpdf);


                //ref.addEventListener('loadstop', function(event) {
                    /*if (device.platform === 'iOS' && parseFloat(device.version) >= 7.0) {
                     StatusBar.overlaysWebView(false);
                     alert('end');
                     //StatusBar.styleDefault();
                     //StatusBar.backgroundColorByName("red");
                     //document.body.style.marginTop = "20px";
                     // StatusBar.backgroundColorByHexString("#00388C");
                     }*/
                //});
                var exitcallback = function() {
                    checkConnection();
                    //ref.removeEventListener('exit', exitcallback);
                };
                ref.addEventListener('exit', exitcallback);
                //ref.addEventListener('loadstart', function() { alert('start: ' + event.url); });
                //ref.addEventListener('loadstop', function() { alert('stop: ' + event.url); });
                //ref.addEventListener('exit', function() { alert(event.type); });
                /*$("#loading").show();
                $("#tryagain").show();*/
                
                

            }
            function onDeviceReady() {
                //document.addEventListener("backbutton", onBackbuttonPress, false);
                $(document).ready(function() {
                    if (device.platform === 'iOS' && parseFloat(device.version) >= 7.0) {
                        StatusBar.overlaysWebView(false);
                        // StatusBar.backgroundColorByHexString("#00388C");
                    }
                    checkConnection();
                });
                /*debuglog();
                 alert("document.close()");
                 document.close();
                 alert("window.close()");
                 window.close();*/
            }

            function printObject(o) {
                var out = '';
                for (var p in o) {
                    out += '<strong>' + p + '</strong>: ' + o[p] + "\r\n<br/>";
                }
                document.write(out);
            }
            /*function debuglog()
             {
             document.write("<h2>navigator.connection</h2>"+navigator.connection);
             //document.write("<h2>Object Navigator</h2>");
             printObject(navigator.connection);
             document.write("<h2>navigator</h2>");
             printObject(navigator);/*
             document.write("<h2>Object Navigator.device.capture</h2>");
             printObject(navigator.device.capture);
             document.write("<h2>Object history</h2>");
             printObject(history);
             document.write("<h2>Object document</h2>");
             printObject(document);
             //document.write("<h2>Object window</h2>");
             //printObject(window);
             }  */
            function checkConnection() {
                var networkState = navigator.connection.type;
                $("#tryagain").hide();
                //var connectionStatus = ((navigator.onLine) ? 'online' : 'offline');
                //alert('ok2');
                //alert(connectionStatus);
                //printObject(navigator);
                if (networkState != 'none') {
                    if (history.length > 1) {
                        if (confirm("Are you sure do you want quit mobile.fisski.com?") && navigator.app) {
                            navigator.app.exitApp();
                        } else {
                            fct_clearcache();

                            //top.document.location = 'http://m.fisski.com?inapp=true';
                        }
                    } else {
                        fct_clearcache();
                        //top.document.location = 'http://m.fisski.com?inapp=true';
                    }
                } else {
                    $("#loading").hide();
                    fct_exitapp();
                }
            }
            function fct_loadfisdata(v_url){
                if (v_url.indexOf("http://") == -1){
                    v_url = 'http://mobile.fis-ski.com'+v_url;
                }
                $.jsonp({
                        url: v_url+'&json=true&callback=myfunct',
                        callbackParameter: 'callback',
                        timeout: 25000,
                        success: function(data, status) {
                            //$('#your-tweets').append('<li>The feed loads fine');
                            $('#pagecontent').html(data.fishtml).trigger('create');
                            $('a').unbind('click');
                            $('form').unbind('submit');
                            $('a').click(function(e){
                                fct_loadfisdata($(this).attr('href').replace('mobile-menu.html','mobile-menu1.html'));
                                e.preventDefault();
                                e.stopImmediatePropagation();
                            });
                            $('form').submit(function(e){
                                alert($(this).attr('action').replace('mobile-menu.html','mobile-menu1.html')+'?'+$(this).serialize());
                                fct_loadfisdata($(this).attr('action').replace('mobile-menu.html','mobile-menu1.html')+'?'+$(this).serialize());
                                e.preventDefault();
                                e.stopImmediatePropagation();
                            });
                        },
                        error: function(){
                            $("#loading").show();
                            $("#tryagain").show();
                            $('#pagecontent').append('There was an error loading the feed');
                        }
                    });
            }
            
            $(document).on( "pagebeforecreate", function(event) {
                    fct_loadfisdata('http://mobile.fis-ski.com/uk/mobile/fis-for-mobile2.html?json=true&inapp=true&callback=myfunct&v=43456');
                });
                
        </script>
    </head>
    <body>
        <div data-role="page" data-theme="a" id="home">
        <div data-role="header" data-position="fixed">
            <div id="fis"></div>

            <!--div id="fis-home"></div-->
            <h1 class="ui-title">FIS-Ski mobile app</h1>
            I'm still in App :P
            <a href="http://movile.fis-ski.com/uk/mobile/bile-settings.html" data-role="button" data-icon="gear" data-iconpos="notext" data-theme="b" data-transition="flip" class="ui-btn-right">Settings</a>
        </div>
                <div id="pagecontent">
                    <div data-role="content">
                    <ul data-inset="true" data-dividertheme="a" data-theme="a" class="ui-listview" data-role="listview" >
                        <li data-role="list-divider" role="heading" id="loading" style="display:none">Loading...</li>
                        <li id="tryagain" style="display: none">
                            <a href="javascript:checkConnection();" data-transition="slide">Click here to try again</a></li>
                        <li>
                    </ul>
                </div>
                </div>
            </div>
        
    </body>
</html>
